<#include "/common/head.html">
<link rel="stylesheet" href="${base}/resources/css/loading.css">
<#include "/common/bodyStart.html">
<style>
    html .layui-layer-demo{background-color:#eee;}
    .layui-layer-demo .layui-layer-title{border:none; background-color:#333; color:#fff;}
</style>
<div class="layui-layout layui-layout-admin">
    <#include "/common/headContent.html">
    <#include "/common/left4.html">
    <div class="layui-body">
        <div style="padding: 15px;">
            <fieldset class="layui-elem-field">
                <legend>查询</legend>
                <div class="layui-col-md12">
                    <div class="layui-form" action="">
                        <div class="layui-form-item">
                            <label class="layui-form-label">时段选择：</label>
                            <div class="layui-input-inline" style="width: 300px;">
                                <input type="text" name="dateStr" id="dateStr" placeholder=" ~ " readonly="" class="layui-input" />
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">手机号：</label>
                            <div class="layui-input-inline" style="width: 300px;">
                                <textarea name="phones" cols="39" rows="2" placeholder="请输入手机号"></textarea>
                            </div>
                            <div class="layui-input-inline" style="width: 90px">
                                <button class="layui-btn layui-btn-normal" type="button" data-type="showInfo">查看详情</button>
                            </div>
                            <div class="layui-form-mid layui-word-aux">可多选，每个号码请折行，不填写则视为全部</div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">任务ID：</label>
                            <div class="layui-input-inline" style="width: 300px;">
                                <input type="text" name="taskIds" class="layui-input" placeholder="请输入任务ID" />
                            </div>
                            <div class="layui-input-inline" style="width: 90px">
                                <button class="layui-btn layui-btn-normal" type="button" data-type="showInfo">查看详情</button>
                            </div>
                            <div class="layui-form-mid layui-word-aux">可多选，请用英文“,”隔开</div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">品牌名称：</label>
                            <div class="layui-input-inline" style="width: 300px;">
                                <input type="text" name="brandNames" class="layui-input" placeholder="请输入品牌名称" />
                            </div>
                            <div class="layui-input-inline" style="width: 90px">
                                <button class="layui-btn layui-btn-normal" type="button" data-type="showInfo">查看详情</button>
                            </div>
                            <div class="layui-form-mid layui-word-aux">可多选，请用英文“,”隔开，不选填写视为全部品牌</div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">厂商名称：</label>
                            <div class="layui-input-inline" style="width: 300px;">
                                <input type="text" name="tradeNames" class="layui-input" placeholder="请输入厂商名称" />
                            </div>
                            <div class="layui-input-inline" style="width: 90px">
                                <button class="layui-btn layui-btn-normal" type="button" data-type="showInfo">查看详情</button>
                            </div>
                            <div class="layui-form-mid layui-word-aux">可多选，请用英文“,”隔开, 不选填写视为全部厂商，<br />填写该条件后品牌则不可填写即不作为条件进行查询</div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">车系名称：</label>
                            <div class="layui-input-inline" style="width: 300px;">
                                <input type="text" name="carSysNames" class="layui-input" placeholder="请输入车系名称" />
                            </div>
                            <div class="layui-input-inline" style="width: 90px">
                                <button class="layui-btn layui-btn-normal" type="button" data-type="showInfo">查看详情</button>
                            </div>
                            <div class="layui-form-mid layui-word-aux">可多选，请用英文“,”隔开, 不选填写视为全部车系，<br />填写该条件后品牌和厂商则不可填写即不作为条件进行查询</div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">城市名称：</label>
                            <div class="layui-input-inline" style="width: 300px;">
                                <input type="text" name="cityNames" class="layui-input" placeholder="请输入城市名称" />
                            </div>
                            <div class="layui-input-inline" style="width: 90px">
                                <button class="layui-btn layui-btn-normal" type="button" data-type="showInfo">查看详情</button>
                            </div>
                            <div class="layui-form-mid layui-word-aux">可多选，请用英文“,”隔开，可填写省名称则视为该省<br />全部城市被选中，不选填写视为全国城市，例：上海市,河北省</div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">包名：</label>
                            <div class="layui-input-inline" style="width: 300px;">
                                <input type="text" name="packageNames" class="layui-input" placeholder="请输入包名" />
                            </div>
                            <div class="layui-input-inline" style="width: 90px">
                                <button class="layui-btn layui-btn-normal" type="button" data-type="showInfo">查看详情</button>
                            </div>
                            <div class="layui-form-mid layui-word-aux">可多选，请用英文“,”隔开，不填写则视为全部</div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">来源：</label>
                            <div class="layui-input-inline" style="width: 300px;">
                                <input type="text" name="sourceTags" class="layui-input" placeholder="请输入来源" />
                            </div>
                            <div class="layui-input-inline" style="width: 90px">
                                <button class="layui-btn layui-btn-normal" type="button" data-type="showInfo">查看详情</button>
                            </div>
                            <div class="layui-form-mid layui-word-aux">可多选，请用英文“,”隔开，不填写则视为全部</div>
                        </div>
                        <div class="layui-form-item">
                                <button class="layui-btn layui-btn-fluid layui-btn-normal" data-type="find">搜索</button>
                        </div>
                    </div>
                </div>
            </fieldset>
            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
                <legend>
                    查询结果：<span id="total"></span>
                    <button class="layui-btn layui-btn-normal" type="button" onclick="exportExcel()">全部导出</button>
                    <a id = "exportExcel" style="display: none" href=""><span>export</span></a>
                </legend>
            </fieldset>
            <table class="layui-hide" id="findList" lay-filter="findList"></table>
        </div>
    </div>
    <div id="loading">
        <div id="loading-center">
            <div id="loading-center-absolute" align="center">
                <div class="object" id="object_one"></div>
                <div class="object" id="object_two"></div>
                <div class="object" id="object_three"></div>
                <div class="layui-progress-big" lay-showPercent="true" style="margin-top:140px;">
                    <!--<div class="layui-progress-bar" lay-percent="0%"></div>-->
                </div>
                <button id="closeLoading" type="button" class="layui-btn layui-btn-danger" style="margin-top:45px;">取消</button>
            </div>
        </div>
    </div>
    <#include "/common/footer.html">
</div>
<#include "/common/js.html">
<!-- 自定义 js -->
<script type="text/html" id="insertDate">
    {{util.toDateString(d.uploadDate,'yyyy-MM-dd HH:mm:ss')}}
</script>
<script>
    var loading,index;
    layui.use(['table','form','layer','laydate'], function(){
        var table = layui.table;
        var form = layui.form;
        var layer = layui.layer,laydate = layui.laydate;
        laydate.render({
            elem:'#dateStr'
            ,range: '~'
            ,value: dateStr(30)
            ,trigger: 'click'
            ,theme: 'molv'
            ,done: function (value, date, endDate) {
                dateVal = value;
            }
        });
        //展示已知数据
        var tableIns = table.render({
            id: 'carDatas'
            ,elem: '#findList'
            ,url:''
            ,method:'post'
            ,cols: [[ //标题栏
                {title: '序号', type:'numbers', align:'center' }
                ,{field: 'uploadDate', title: '上传时间', templet:'#insertDate', align:'center'}
                ,{field: 'taskId', title: '任务ID', align:'center'}
                ,{field: 'name', title: '姓名', align:'center'}
                ,{field: 'phone', title: '手机', align:'center'}
                ,{field: 'provName', title: '省', align:'center'}
                ,{field: 'cityName', title: '城市名称', align:'center'}
                ,{field: 'carSys', title: '车系', align:'center'}
                ,{field: 'brand', title: '品牌', align:'center'}
                ,{field: 'trade', title: '厂商', align:'center'}
                ,{field: 'fileNameBak', title: '包名'}
                ,{field: 'fileName', title: '文件名'}
                ,{field: 'sourceTag', title: '来源', align:'center'}
                ,{field: 'bigLibRepeatCount', title: '大库重复条数', align:'center', templet: function (d) {
                        if(d.bigLibRepeatCount > 0) {
                            return "<a href=\"javascript:void(0);\" onclick=\"errInfo('1', '" + d.id + "')\" class=\"layui-table-link\">" + d.bigLibRepeatCount + "</a>";
                        }else {
                            return d.bigLibRepeatCount;
                        }
                    }}
                ,{field: 'brandCount', title: '品牌重复次数', align:'center', templet: function (d) {
                        if(d.brandCount > 0) {
                            return "<a href=\"javascript:void(0);\" onclick=\"errInfo('7', '" + d.id + "')\" class=\"layui-table-link\">" + d.brandCount + "</a>";
                        }else {
                            return d.brandCount;
                        }
                    }}
                ,{field: 'tradeCount', title: '厂商重复次数', align:'center', templet: function (d) {
                        if(d.tradeCount > 0) {
                            return "<a href=\"javascript:void(0);\" onclick=\"errInfo('8', '" + d.id + "')\" class=\"layui-table-link\">" + d.tradeCount + "</a>";
                        }else {
                            return d.tradeCount;
                        }
                    }}
                ,{field: 'carSysRepeatCount', title: '车系重复条数', align:'center', templet: function (d) {
                        if(d.carSysRepeatCount > 0) {
                            return "<a href=\"javascript:void(0);\" onclick=\"errInfo('3', '" + d.id + "')\" class=\"layui-table-link\">" + d.carSysRepeatCount + "</a>";
                        }else {
                            return d.carSysRepeatCount;
                        }
                    }}
            ]]
            //,skin: 'line' //表格风格
            ,even: true //隔行换色
            ,page: true //是否显示分页
            //,limits: [5, 7, 10]
            //,limit: 5 //每页默认显示的数量
            ,done: function (res, curr, count) {
                $("#total").html(count + "条");
                $("#loading").hide();
            }
        });
        $('.layui-btn-normal').on('click', function(){
            var type = $(this).data('type');
            if(!isNull(type) && type == 'showInfo') {
                var val = $(this).parent().prev().children().val();
                if(!isNull(val)) {
                    layer.open({
                        type: 1,
                        title: false,
                        skin: 'layui-layer-demo', //样式类名
                        area: '315px',
                        closeBtn: false, //不显示关闭按钮
                        anim: 2,
                        shadeClose: true, //开启遮罩关闭
                        content: '<div style="padding:20px;width: 275px;display:block;word-break: break-all;word-wrap: break-word;">' + val + '</div>'
                    });
                }else {
                    layer.msg("信息项为空",function(){});
                }
            }
            if(!isNull(type) && type == 'find') {
                $("#loading").show();
                var dateStr = $("input[name='dateStr']").val();
                var phones = $("textarea[name='phones']").val();
                var taskIds = $("input[name='taskIds']").val();
                var brandNames = $("input[name='brandNames']").val();
                var tradeNames = $("input[name='tradeNames']").val();
                var carSysNames = $("input[name='carSysNames']").val();
                var cityNames = $("input[name='cityNames']").val();
                var packageNames = $("input[name='packageNames']").val();
                var sourceTags = $("input[name='sourceTags']").val();
                tableIns.reload({
                    url:"${base}/car/find",
                    page:{
                        curr:1
                    },
                    where:{
                        dateStr: dateStr,
                        phones: phones,
                        taskIds: taskIds,
                        brandNames: brandNames,
                        tradeNames: tradeNames,
                        carSysNames: carSysNames,
                        cityNames: cityNames,
                        packageNames: packageNames,
                        sourceTags: sourceTags
                    }
                });
            }
        });
    });
    function exportExcel() {
        if(!isNull($("#total").html()) && $("#total").html()!="0条") {
            var loading = layer.load(0, {shade: [0.4, '#000']});
            var $a = $("#exportExcel");
            $a.attr("href", "${base}/car/find/exportExcel");
            $("#exportExcel span").trigger('click');
            var t = setInterval(function () {
                $.ajax({
                    url: "${base}/car/find/exportStatus",
                    type: "post",
                    success: function (result) {
                        if (result.status == 'Y') {
                            clearInterval(t);
                            layer.close(loading);
                        }
                    }
                })
            }, 1000);
        }else {
            layer.msg("无数据", function () {})
        }
    }
    function errInfo(code, fileId) {
        window.location = "${base}/car/list/errInfo?err=" + code + "&fileId=" + fileId;
    }
    $("#closeLoading").on("click", function () {
        window.location.reload(true);
    })
</script>
<#include "/common/bodyEnd.html">