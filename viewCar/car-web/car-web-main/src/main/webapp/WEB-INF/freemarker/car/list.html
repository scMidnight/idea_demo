<#include "/common/head.html">
<#include "/common/bodyStart.html">
<div class="layui-layout layui-layout-admin">
    <#include "/common/headContent.html">
    <#include "/common/left.html">
    <div class="layui-body">
        <div style="padding: 15px;">
            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
                <legend>
                    数据列表&emsp;
                    <a class="layui-btn layui-btn-normal" href="${base}/car/uploader"><i class="layui-icon layui-icon-add-1"></i>上传数据</a>
                </legend>
            </fieldset>
            <blockquote class="layui-elem-quote">
                <div class="layui-form" lay-filter="one">
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label" style="width: 120px;">大库检查时段</label>
                            <div class="layui-input-inline" style="width: 200px;">
                                <input type="text" name="dateStr" id="dateStr" placeholder=" ~ " readonly="" class="layui-input" />
                            </div>
                        </div>
                        <div class="layui-inline">
                            <button type="button" class="layui-btn layui-btn-normal" id="shangchuan" >重新检查时间范围内数据包</button>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label" style="width: 120px;">导出时屏蔽数据</label>
                        <div class="layui-input-block">
                            <input type="checkbox" name="filter" value="1" title="大库重复" />
                            <input type="checkbox" name="filter" value="2" title="任务重复" checked />
                            <input type="checkbox" name="filter" value="3" title="车系重复" checked />
                            <input type="checkbox" name="filter" value="4" title="黑名单命中" checked />
                            <input type="checkbox" name="filter" value="5" title="号段错误" checked />
                            <input type="checkbox" name="filter" value="6" title="ID转失败" checked />
                        </div>
                    </div>
                </div>
            </blockquote>
            <table class="layui-hide" id="carList" lay-filter="carList"></table>
            <a id = "exportPackage" style="display: none" href=""><span>exportPackage</span></a>
        </div>
    </div>
    <#include "/common/footer.html">
</div>
<#include "/common/js.html">
<script type="text/html" id="fileNameBak">
    {{d.fileBean.fileNameBak}}
</script>
<script type="text/html" id="uploadDate">
    {{util.toDateString(d.fileBean.uploadDate)}}
</script>
<script type="text/html" id="operate">
    {{# if (d.fileBean.status == '0')  { }}
        <a class="layui-btn layui-btn-xs" lay-event="checkPackage">检查整理</a>
    {{# } else { }}
        <a class="layui-btn layui-btn-xs" lay-event="checkAgainPackage">重新检查</a>
        <a class="layui-btn layui-btn-xs" lay-event="detail">详情</a>
        <a class="layui-btn layui-btn-xs" lay-event="exportPackage">导出</a>
    {{# } }}
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="delPackage">删除</a>
</script>
<!-- 自定义 js -->
<script>
    var dateVal = "";
    var t;
    function closeLoad(index) {
        layer.close(index);
        clearTimeout(t);
    }
    layui.use(['form','table','laydate'], function () {
        var form = layui.form,table = layui.table,laydate = layui.laydate;
        laydate.render({
            elem:'#dateStr'
            ,range: '~'
            ,value: dateStr(90)
            ,trigger: 'click'
            ,theme: 'molv'
            ,done: function (value, date, endDate) {
                dateVal = value;
            }
        });
        var tableIns = table.render({
            elem: '#carList'
            ,url: '${base}/car/list'
            ,method:'post'
            ,height: 'full-400'
            ,cols: [[
                {field:'fileNameBak', title:'文件包名', width:300,fixed:'left', templet:'#fileNameBak'}
                ,{field:'uploadDate', title:'上传时间', width:160, templet:'#uploadDate'}
                ,{field:'fileCount', title:'文件总数', align:'center'}
                ,{field:'sumCount', title:'合计条数', align:'center'}
                ,{field:'problemCount', title:'问题条数', align:'center'}
                ,{field:'taskRepeatCount', title:'任务重复', align:'center', templet: function (d) {
                        if(d.taskRepeatCount > 0) {
                            return "<a href=\"javascript:void(0);\" onclick=\"errInfo('2', '" + d.fileBean.id + "')\" class=\"layui-table-link\">" + d.taskRepeatCount + "</a>";
                        }else {
                            return d.taskRepeatCount;
                        }
                    }}
                ,{field:'carSysRepeatCount', title:'车系重复', align:'center', templet: function (d) {
                        if(d.carSysRepeatCount > 0) {
                            return "<a href=\"javascript:void(0);\" onclick=\"errInfo('3', '" + d.fileBean.id + "')\" class=\"layui-table-link\">" + d.carSysRepeatCount + "</a>";
                        }else {
                            return d.carSysRepeatCount;
                        }
                    }}
                ,{field:'bigLibraryRepeatCount', title:'大库重复', align:'center', templet: function (d) {
                        if(d.bigLibraryRepeatCount > 0) {
                            return "<a href=\"javascript:void(0);\" onclick=\"errInfo('1', '" + d.fileBean.id + "')\" class=\"layui-table-link\">" + d.bigLibraryRepeatCount + "</a>";
                        }else {
                            return d.bigLibraryRepeatCount;
                        }
                    }}
                ,{field:'blackHitRepeatCount', title:'黑名单命中', align:'center', templet: function (d) {
                        if(d.blackHitRepeatCount > 0) {
                            return "<a href=\"javascript:void(0);\" onclick=\"errInfo('4', '" + d.fileBean.id + "')\" class=\"layui-table-link\">" + d.blackHitRepeatCount + "</a>";
                        }else {
                            return d.blackHitRepeatCount;
                        }
                    }}
                ,{field:'numberErrCount', title:'号段错误', align:'center', templet: function (d) {
                        if(d.numberErrCount > 0) {
                            return "<a href=\"javascript:void(0);\" onclick=\"errInfo('5', '" + d.fileBean.id + "')\" class=\"layui-table-link\">" + d.numberErrCount + "</a>";
                        }else {
                            return d.numberErrCount;
                        }
                    }}
                ,{field:'idFailedCount', title:'ID转失败', align:'center', templet: function (d) {
                        if(d.idFailedCount > 0) {
                            return "<a href=\"javascript:void(0);\" onclick=\"errInfo('6', '" + d.fileBean.id + "')\" class=\"layui-table-link\">" + d.idFailedCount + "</a>";
                        }else {
                            return d.idFailedCount;
                        }
                    }}
                ,{field:'right', title:'操作', toolbar:'#operate', width:260, fixed:'right', align:'center'}
            ]]
            ,even: true //隔行换色
            ,page: true
        });
        table.on('tool(carList)', function (obj) {
            var $data = obj.data;
            var layEvent = obj.event;
            var loading;
            if(layEvent == 'checkPackage') {
                loading = layer.load(0,{shade: [0.4,'#000']});
                $.ajax({
                    url:"${base}/car/list/checkPackage",
                    data:{id:$data.fileBean.id},
                    dataType:"json",
                    type:"post",
                    success:function (result) {
                        if(result.status=="Y"){
                            layer.msg('整理完毕！', {
                                icon: 1,
                                time: 1000 //1秒关闭（如果不配置，默认是3秒）
                            });
                            layer.close(loading);
                            tableIns.reload({
                                page:{
                                    curr:1
                                }
                            });
                        }else{
                            layer.alert(result.msg);
                        }
                    }
                });
            }
            if(layEvent == 'checkAgainPackage') {
                loading = layer.load(0,{shade: [0.4,'#000']});
                $.ajax({
                    url:"${base}/car/list/checkAgainPackage",
                    data:{id:$data.fileBean.id},
                    dataType:"json",
                    type:"post",
                    success:function (result) {
                        if(result.status=="Y"){
                            layer.msg('重新整理完毕！', {
                                icon: 1,
                                time: 1000 //1秒关闭（如果不配置，默认是3秒）
                            });
                            layer.close(loading);
                            tableIns.reload({
                                page:{
                                    curr:1
                                }
                            });
                        }else{
                            layer.alert(result.msg);
                        }
                    }
                });
            }
            if(layEvent == 'detail') {
                window.location = "${base}/car/list/info?fileId=" + $data.fileBean.id;
            }
            if(layEvent == 'exportPackage') {
                var arr = new Array();
                $("input:checkbox[name='filter']:checked").each(function (i) {
                    arr[i] = $(this).val();
                });
                loading = layer.load(0,{shade: [0.4,'#000']});
                var $a = $("#exportPackage");
                $a.attr("href", "${base}/car/list/exportPackage?id=" + $data.fileBean.id + "&arrs=" + arr.join(","));
                $("#exportPackage span").trigger('click');
                getExportPackageRes(loading);
            }
            if(layEvent == 'delPackage') {
                layer.confirm('您确定要删除此条数据吗？', {icon: 3}, function (index) {
                    $.ajax({
                        url:"${base}/car/list/del",
                        data:{id:$data.fileBean.id},
                        dataType:"json",
                        type:"post",
                        success:function (result) {
                            obj.del();
                            layer.close(index);
                            if(result.status=="Y"){
                                layer.msg('删除成功！', {
                                    icon: 1,
                                    time: 1000 //1秒关闭（如果不配置，默认是3秒）
                                });
                            }else{
                                layer.alert(result.msg);
                            }
                        }
                    });
                });
            }
        });
        function getExportPackageRes(index) {
            if(!isNull(t)) {
                clearTimeout(t);
            }
            var res;
            $.ajax({
                url:'${base}/car/list/exportPackageRes',
                dataType: "json",
                type:"get",
                async:false,
                success:function (result) {
                    if(result.status=="Y") {
                        res = true;
                    }else {
                        res = false;
                    }
                }
            });
            if(res){
                closeLoad(index);
            }else {
                t = setTimeout(function () { getExportPackageRes(index); }, 1000);
            }
        }
    });
    function errInfo(code, fileId) {
        window.location = "${base}/car/list/errInfo?err=" + code + "&fileId=" + fileId;
    }
</script>
<#include "/common/bodyEnd.html">